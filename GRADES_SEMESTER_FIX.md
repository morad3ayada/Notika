# إصلاح تحديد الفصل الدراسي التلقائي في شاشة الدرجات

## المشكلة

1. **الفصل الدراسي كان ثابت**: كان `currentSemester` معرّف بشكل ثابت كـ `'الثاني'`
2. **لا يفتح على الفصل الصحيح**: عند فتح الشاشة، كان يفتح دائماً على الفصل الثاني بغض النظر عن التاريخ الحالي
3. **الحقول read-only في الفصل الأول**: لم يكن بإمكان المعلم التعديل في الفصل الأول
4. **زر الحفظ مخفي في الفصل الأول**: كان زر "حفظ الدرجات" يظهر فقط في الفصل الثاني
5. **الفصل الثاني يظهر قبل موعده**: كان زر الفصل الثاني موجود حتى قبل شهر فبراير

## السبب الجذري

### 1. تعريف ثابت للفصل

```dart
// ❌ الكود القديم
String currentSemester = 'الثاني';
```

هذا يعني أن الفصل دائماً "الثاني" بغض النظر عن الوقت الفعلي من السنة.

### 2. قيود على التعديل

```dart
// ❌ الكود القديم
readOnly: currentSemester != 'الثاني',
```

هذا يجعل الحقول **read-only** (غير قابلة للتعديل) في الفصل الأول.

### 3. إخفاء زر الحفظ

```dart
// ❌ الكود القديم
if (currentSemester == 'الثاني')
  Padding(
    child: ElevatedButton(...),
  ),
```

هذا يُظهر زر الحفظ **فقط** في الفصل الثاني.

## الحل

### 1. إضافة دالة لتحديد الفصل تلقائياً

```dart
/// تحديد الفصل الدراسي بناءً على التاريخ الحالي
/// الفصل الأول: من سبتمبر (9) إلى يناير (1)
/// الفصل الثاني: من فبراير (2) إلى يونيو (6)
static String _getCurrentSemester() {
  final now = DateTime.now();
  final month = now.month;
  
  // الفصل الثاني: من فبراير (2) إلى أغسطس (8)
  // الفصل الأول: من سبتمبر (9) إلى يناير (1)
  if (month >= 2 && month <= 8) {
    return 'الثاني';
  } else {
    return 'الأول';
  }
}
```

**المنطق:**
- **الأشهر 2-8** (فبراير - أغسطس) → **الفصل الثاني** ✅
- **الأشهر 9-1** (سبتمبر - يناير) → **الفصل الأول** ✅

### 1.5. إضافة دالة للتحقق من إمكانية عرض الفصل الثاني

```dart
/// التحقق من إمكانية عرض الفصل الثاني
/// الفصل الثاني يظهر فقط من شهر فبراير (2) إلى يوليو (7)
static bool _canShowSecondSemester() {
  final now = DateTime.now();
  return now.month >= 2 && now.month <= 7;
}
```

**المنطق:**
- **الأشهر 1، 8-12** (يناير، أغسطس-ديسمبر) → **لا يظهر الفصل الثاني** ❌
- **الأشهر 2-7** (فبراير - يوليو) → **يظهر الفصل الثاني** ✅

### 2. استخدام الدالة عند التهيئة

```dart
// ✅ الكود الجديد
String currentSemester = _getCurrentSemester();
```

الآن `currentSemester` يُحدد **تلقائياً** بناءً على التاريخ الحالي.

### 3. إزالة قيد التعديل

```dart
// ✅ الكود الجديد - السماح بالتعديل في كلا الفصلين
readOnly: false,
```

الآن يمكن للمعلم التعديل في **كلا الفصلين**.

### 4. إزالة قيد زر الحفظ

```dart
// ✅ الكود الجديد - زر الحفظ متاح في كلا الفصلين
Padding(
  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
  child: SizedBox(
    width: double.infinity,
    child: ElevatedButton(
      onPressed: _saveGrades,
      child: const Text('حفظ الدرجات'),
    ),
  ),
),
```

زر الحفظ الآن **دائماً ظاهر** في كلا الفصلين.

### 5. إخفاء/إظهار زر الفصل الثاني بناءً على التاريخ

```dart
// ✅ الكود الجديد
child: _canShowSecondSemester()
    ? Row(
        children: [
          Expanded(child: /* زر الفصل الأول */),
          Expanded(child: /* زر الفصل الثاني */),
        ],
      )
    : GestureDetector(
        child: Container(
          /* زر الفصل الأول بعرض كامل */
        ),
      ),
```

**المنطق:**
- **من فبراير فصاعداً** → يظهر **زران** (الفصل الأول + الفصل الثاني) ✅
- **قبل فبراير** → يظهر **زر واحد** (الفصل الأول فقط بعرض كامل) ✅

## توزيع الأشهر على الفصول

| الشهر | الرقم | الفصل الافتراضي | الأزرار المعروضة |
|-------|------|----------------|------------------|
| يناير | 1 | الفصل الأول 📘 | **فقط الفصل الأول** ⭐ |
| فبراير | 2 | الفصل الثاني 📗 | الأول + الثاني |
| مارس | 3 | الفصل الثاني 📗 | الأول + الثاني |
| أبريل | 4 | الفصل الثاني 📗 | الأول + الثاني |
| مايو | 5 | الفصل الثاني 📗 | الأول + الثاني |
| يونيو | 6 | الفصل الثاني 📗 | الأول + الثاني |
| يوليو | 7 | الفصل الثاني 📗 | الأول + الثاني |
| أغسطس | 8 | الفصل الأول 📘 | **فقط الفصل الأول** ⭐ |
| سبتمبر | 9 | الفصل الأول 📘 | **فقط الفصل الأول** ⭐ |
| أكتوبر | 10 | الفصل الأول 📘 | **فقط الفصل الأول** ⭐ |
| نوفمبر | 11 | الفصل الأول 📘 | **فقط الفصل الأول** ⭐ |
| ديسمبر | 12 | الفصل الأول 📘 | **فقط الفصل الأول** ⭐ |

**ملاحظة مهمة:**
- ✅ الفصل الثاني **يظهر فقط** من شهر **2 (فبراير)** إلى شهر **7 (يوليو)**
- ✅ في باقي الأشهر (1، 8-12) يظهر **الفصل الأول فقط**

## السيناريوهات

### سيناريو 1: فتح التطبيق في ديسمبر (12)

```
التاريخ: 15 ديسمبر 2024
الشهر: 12
النتيجة: الفصل الأول ✅
الأزرار المعروضة: الفصل الأول + الفصل الثاني ✅
يمكن التعديل: نعم (في كلا الفصلين) ✅
زر الحفظ: ظاهر ✅
```

### سيناريو 2: فتح التطبيق في يناير (1) ⭐

```
التاريخ: 20 يناير 2025
الشهر: 1
النتيجة: الفصل الأول ✅
الأزرار المعروضة: الفصل الأول فقط ❗
زر الفصل الثاني: مخفي تماماً ✅
يمكن التعديل: نعم (في الفصل الأول) ✅
زر الحفظ: ظاهر ✅
```

### سيناريو 3: فتح التطبيق في فبراير (2) ⭐

```
التاريخ: 10 فبراير 2025
الشهر: 2
النتيجة: الفصل الثاني ✅
الأزرار المعروضة: الفصل الأول + الفصل الثاني ✅
زر الفصل الثاني: يظهر الآن! 🎉
يمكن التعديل: نعم (في كلا الفصلين) ✅
زر الحفظ: ظاهر ✅
```

### سيناريو 4: فتح التطبيق في يوليو (7)

```
التاريخ: 5 يوليو 2025
الشهر: 7
النتيجة: الفصل الثاني ✅
الأزرار المعروضة: الفصل الأول + الفصل الثاني ✅
يمكن التعديل: نعم (في كلا الفصلين) ✅
زر الحفظ: ظاهر ✅
```

### سيناريو 5: فتح التطبيق في سبتمبر (9)

```
التاريخ: 1 سبتمبر 2025
الشهر: 9
النتيجة: الفصل الأول ✅
الأزرار المعروضة: الفصل الأول + الفصل الثاني ✅
يمكن التعديل: نعم (في كلا الفصلين) ✅
زر الحفظ: ظاهر ✅
```

## المزايا الجديدة

### ✅ 1. تحديد تلقائي للفصل

عند فتح شاشة الدرجات، يتم تحديد الفصل **تلقائياً** بناءً على التاريخ الحالي.

### ✅ 2. إخفاء الفصل الثاني قبل موعده ⭐

**الميزة الجديدة:**
- في شهر **يناير** (قبل بداية الفصل الثاني): زر الفصل الثاني **يختفي تماماً** ❌
- من شهر **فبراير** فصاعداً: يظهر زر الفصل الثاني ✅

هذا يمنع الارتباك ويضمن أن المعلم لا يرى الفصل الثاني قبل بدايته الفعلية.

### ✅ 3. التعديل في كلا الفصلين

المعلم يمكنه الآن **التعديل** في الفصل الأول والفصل الثاني.

### ✅ 4. الحفظ في كلا الفصلين

زر "حفظ الدرجات" **دائماً ظاهر** في كلا الفصلين.

### ✅ 5. إمكانية التبديل اليدوي (عند توفر الفصلين)

عندما يكون الفصل الثاني متاحاً (من فبراير فصاعداً)، المعلم يمكنه **التبديل يدوياً** بين الفصلين:

```
┌─────────────┬─────────────┐
│ الفصل الأول │ الفصل الثاني │  ← من فبراير - ديسمبر
└─────────────┴─────────────┘

┌───────────────────────────┐
│       الفصل الأول        │  ← في يناير فقط
└───────────────────────────┘
```

## التعديلات التي تمت

### 1. إضافة دالة `_getCurrentSemester()`

```dart
static String _getCurrentSemester() {
  final now = DateTime.now();
  final month = now.month;
  
  if (month >= 2 && month <= 8) {
    return 'الثاني';
  } else {
    return 'الأول';
  }
}
```

### 2. إضافة دالة `_canShowSecondSemester()`

```dart
static bool _canShowSecondSemester() {
  final now = DateTime.now();
  return now.month >= 2;
}
```

### 3. تحديث `currentSemester` initialization

```dart
// قبل
String currentSemester = 'الثاني';

// بعد
String currentSemester = _getCurrentSemester();
```

### 4. إضافة شرط لإخفاء/إظهار الفصل الثاني

```dart
// قبل - دائماً يعرض زرين
Row(
  children: [
    Expanded(child: /* الفصل الأول */),
    Expanded(child: /* الفصل الثاني */),
  ],
)

// بعد - يعرض زر واحد في يناير، زرين في باقي الأشهر
_canShowSecondSemester()
  ? Row(...) // زرين
  : GestureDetector(...) // زر واحد بعرض كامل
```

### 5. إزالة قيد `readOnly`

```dart
// قبل
readOnly: currentSemester != 'الثاني',

// بعد
readOnly: false,
```

تم في موضعين:
- في `_buildStudentRow()` للدرجات اليومية
- في الجدول الرئيسي

### 6. إزالة شرط `if` لزر الحفظ

```dart
// قبل
if (currentSemester == 'الثاني')
  Padding(...),

// بعد
Padding(...), // دائماً ظاهر
```

## ملاحظات مهمة

### المرونة الكاملة

الآن لدى المعلم **مرونة كاملة**:
- ✅ التطبيق يفتح تلقائياً على الفصل الصحيح
- ✅ يمكن التبديل يدوياً بين الفصلين
- ✅ التعديل متاح في كلا الفصلين
- ✅ الحفظ متاح في كلا الفصلين

### لماذا `month >= 2 && month <= 8`؟

هذا يغطي:
- فبراير (2) → بداية الفصل الثاني
- مارس - أغسطس (3-8) → أثناء وبعد الفصل الثاني

والباقي (سبتمبر - يناير) يكون الفصل الأول.

### يمكن تعديل المنطق لاحقاً

إذا احتاج المعلم تغيير توزيع الأشهر، يمكن بسهولة تعديل الدالة `_getCurrentSemester()`.

## النتيجة النهائية

✅ **التطبيق الآن ذكي**: يحدد الفصل تلقائياً بناءً على التاريخ  
✅ **لا يوجد قيود**: التعديل والحفظ متاحان في كلا الفصلين  
✅ **تجربة أفضل**: المعلم لا يحتاج لتغيير الفصل يدوياً في كل مرة  
✅ **مرونة**: إمكانية التبديل اليدوي عند الحاجة  

## الملفات المُعدلة

1. `lib/presentation/screens/grades/grades_screen.dart` ✅
   - إضافة دالة `_getCurrentSemester()`
   - تحديث `currentSemester` initialization
   - إزالة `readOnly` constraints (موضعين)
   - إزالة شرط `if` لزر الحفظ
